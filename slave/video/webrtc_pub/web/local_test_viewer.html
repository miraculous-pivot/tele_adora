<!DOCTYPE html>
<html>
<head>
    <title>æœ¬åœ°WebRTCæµ‹è¯•</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial; 
            background: #1a1a1a;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        video { 
            width: 100%; 
            max-width: 800px;
            height: auto;
            background: #333;
            border-radius: 8px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #005a99;
        }
        .status {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .info { color: #4fc3f7; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ æœ¬åœ°WebRTCæµ‹è¯•</h1>
        
        <div class="controls">
            <button onclick="connect()">ğŸ”— è¿æ¥</button>
            <button onclick="disconnect()">âŒ æ–­å¼€</button>
            <button onclick="testLocal()">ğŸ§ª æœ¬åœ°æµ‹è¯•</button>
        </div>
        
        <video id="video" autoplay playsinline muted></video>
        
        <div class="status" id="status">
            <div class="info">ğŸ“± å‡†å¤‡è¿æ¥...</div>
        </div>
    </div>

    <script>
        let pc = null;
        let ws = null;
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            status.innerHTML += `<div class="${color}">[${timestamp}] ${msg}</div>`;
            status.scrollTop = status.scrollHeight;
            console.log(msg);
        }
        
        // æœ¬åœ°æµ‹è¯• - å¼ºåˆ¶ä½¿ç”¨hostå€™é€‰
        async function testLocal() {
            try {
                log('ğŸ§ª å¼€å§‹æœ¬åœ°æµ‹è¯•...', 'info');
                
                pc = new RTCPeerConnection({
                    iceServers: [], // ä¸ä½¿ç”¨STUNæœåŠ¡å™¨ï¼Œå¼ºåˆ¶æœ¬åœ°è¿æ¥
                    iceCandidatePoolSize: 0
                });
                
                pc.ontrack = event => {
                    log('ğŸ¥ æ”¶åˆ°è§†é¢‘æµ', 'success');
                    video.srcObject = event.streams[0];
                };
                
                pc.onconnectionstatechange = () => {
                    log(`ğŸ“¡ è¿æ¥çŠ¶æ€: ${pc.connectionState}`, 
                        pc.connectionState === 'connected' ? 'success' : 'info');
                };
                
                pc.oniceconnectionstatechange = () => {
                    log(`ğŸ§Š ICEçŠ¶æ€: ${pc.iceConnectionState}`, 
                        pc.iceConnectionState === 'connected' ? 'success' : 'info');
                };
                
                pc.onicecandidate = event => {
                    if (event.candidate && ws) {
                        log(`ğŸ§Š ICEå€™é€‰: ${event.candidate.type}`);
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate.candidate,
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            sdpMid: event.candidate.sdpMid
                        }));
                    }
                };
                
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = async () => {
                    log('âœ… ä¿¡ä»¤è¿æ¥æˆåŠŸ', 'success');
                    
                    // åªæ¥æ”¶è§†é¢‘
                    pc.addTransceiver('video', { direction: 'recvonly' });
                    
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    ws.send(JSON.stringify({
                        type: 'offer',
                        sdp: offer.sdp
                    }));
                    
                    log('ğŸ“¤ å‘é€æœ¬åœ°Offer');
                };
                
                ws.onmessage = async event => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'answer' && pc.signalingState === 'have-local-offer') {
                        log('ğŸ“¥ æ”¶åˆ°Answer', 'success');
                        await pc.setRemoteDescription(new RTCSessionDescription({
                            type: 'answer',
                            sdp: data.sdp
                        }));
                        log('âœ… è¿œç¨‹æè¿°å·²è®¾ç½®', 'success');
                    }
                };
                
                ws.onerror = error => {
                    log(`âŒ ä¿¡ä»¤é”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`âŒ æœ¬åœ°æµ‹è¯•å¤±è´¥: ${error}`, 'error');
            }
        }
        
        async function connect() {
            try {
                log('ğŸš€ å¼€å§‹è¿æ¥...', 'info');
                
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                let answerReceived = false;
                
                pc.ontrack = event => {
                    log('ğŸ¥ æ”¶åˆ°è§†é¢‘æµ', 'success');
                    video.srcObject = event.streams[0];
                };
                
                pc.onconnectionstatechange = () => {
                    log(`ğŸ“¡ è¿æ¥çŠ¶æ€: ${pc.connectionState}`, 
                        pc.connectionState === 'connected' ? 'success' : 'info');
                };
                
                pc.oniceconnectionstatechange = () => {
                    log(`ğŸ§Š ICEçŠ¶æ€: ${pc.iceConnectionState}`, 
                        pc.iceConnectionState === 'connected' ? 'success' : 'info');
                };
                
                pc.onicecandidate = event => {
                    if (event.candidate && ws) {
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate.candidate,
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            sdpMid: event.candidate.sdpMid
                        }));
                        log('ğŸ§Š å‘é€ICEå€™é€‰');
                    }
                };
                
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = async () => {
                    log('âœ… ä¿¡ä»¤è¿æ¥æˆåŠŸ', 'success');
                    
                    pc.addTransceiver('video', { direction: 'recvonly' });
                    
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    ws.send(JSON.stringify({
                        type: 'offer',
                        sdp: offer.sdp
                    }));
                    
                    log('ğŸ“¤ å‘é€Offer');
                };
                
                ws.onmessage = async event => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'answer') {
                        if (answerReceived) {
                            log('âš ï¸ å¿½ç•¥é‡å¤çš„Answer');
                            return;
                        }
                        
                        if (pc.signalingState !== 'have-local-offer') {
                            log(`âš ï¸ æ— æ³•è®¾ç½®Answerï¼Œå½“å‰çŠ¶æ€: ${pc.signalingState}`);
                            return;
                        }
                        
                        log('ğŸ“¥ æ”¶åˆ°Answer', 'success');
                        await pc.setRemoteDescription(new RTCSessionDescription({
                            type: 'answer',
                            sdp: data.sdp
                        }));
                        log('âœ… è¿œç¨‹æè¿°å·²è®¾ç½®', 'success');
                        answerReceived = true;
                    }
                };
                
                ws.onerror = error => {
                    log(`âŒ ä¿¡ä»¤é”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error}`, 'error');
            }
        }
        
        function disconnect() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (ws) {
                ws.close();
                ws = null;
            }
            video.srcObject = null;
            log('ğŸ”Œ è¿æ¥å·²æ–­å¼€', 'info');
        }
        
        window.addEventListener('beforeunload', disconnect);
    </script>
</body>
</html>
